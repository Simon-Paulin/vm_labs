FROM kali-base:latest

# ===========================================
# Métadonnées
# ===========================================
LABEL maintainer="pentest-lab"
LABEL description="Module Kali Post-Exploitation (linpeas, pspy, etc.)"

# ===========================================
# Installation des outils post-exploitation
# ===========================================
USER root
RUN apt-get update && \
    apt-get install -y \
        lsof \
        procps \
        python3-venv \
        python3-psutil \
        wget curl \
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    # Téléchargement de scripts utiles (linpeas, pspy)
    mkdir -p /opt/postex && \
    wget -q https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh -O /opt/postex/linpeas.sh && \
    wget -q https://github.com/DominicBreuker/pspy/releases/latest/download/pspy64 -O /opt/postex/pspy64 && \
    chmod +x /opt/postex/*

# ===========================================
# Bannière
# ===========================================
RUN sed -i '/Pentest Lab - Module BASE/,+15d' /home/kali/.bashrc && \
    echo '\
BLUE="\\033[0;34m"\n\
GREEN="\\033[0;32m"\n\
YELLOW="\\033[0;33m"\n\
NC="\\033[0m"\n\
\n\
echo -e "${BLUE}=====================================${NC}"\n\
echo -e "${GREEN}   🎯 Pentest Lab - Module POST-EX${NC}"\n\
echo -e "${BLUE}=====================================${NC}"\n\
echo ""\n\
echo -e "${YELLOW}Outils disponibles :${NC}"\n\
echo " - 📜 Linpeas          : /opt/postex/linpeas.sh"\n\
echo " - 👀 Pspy             : /opt/postex/pspy64"\n\
echo " - 📊 Psutil (Python)  : $$(python3 -c \"import psutil; print('psutil OK')\")"\n\
echo " - 📂 Lsof             : $$(lsof -v 2>&1 | head -n1)"\n\
echo " - 🖥️ Procps           : outils (ps, top, free, etc.)"\n\
echo ""\n\
echo -e "${YELLOW}Files :${NC} /workspace"\n\
echo -e "${YELLOW}User        :${NC} kali"\n\
echo -e "${BLUE}=====================================${NC}"\n\
' >> /home/kali/.bashrc

# ===========================================
# Configuration utilisateur final
# ===========================================
USER kali
WORKDIR /workspace

CMD ["/bin/bash"]
