FROM kalilinux/kali-rolling

# ===========================================
# Métadonnées
# ===========================================
LABEL maintainer="pentest-lab"
LABEL description="Base Kali avec outils essentiels et logging auto"

# ===========================================
# Configuration de base
# ===========================================
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# ===========================================
# Mise à jour et installation des outils
# ===========================================
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y \
        curl wget git vim nano htop tree \
        net-tools iputils-ping dnsutils \
        unzip zip p7zip-full \
        tmux screen \
        ca-certificates \
        software-properties-common \
        build-essential \
        python3 python3-pip python3-dev \
        python3-pwntools \
        python3-requests python3-bs4 python3-colorama \
        libssl-dev libffi-dev libc6-dev \
        binutils gcc g++ make \
        nmap netcat-traditional socat \
        metasploit-framework exploitdb \
        hydra john hashcat \
        sqlmap nikto gobuster wfuzz \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# ===========================================
# Configuration utilisateur
# ===========================================
RUN useradd -m -s /bin/bash kali && \
    echo "kali:kali" | chpasswd && \
    usermod -aG sudo kali

# ===========================================
# Structure des dossiers
# ===========================================
RUN mkdir -p /workspace /reports /exploits && \
    chown -R kali:kali /workspace /reports /exploits

# ===========================================
# Bannière + Logging auto dans ~/.bashrc
# ===========================================
RUN echo '\
BLUE="\\033[0;34m"\n\
GREEN="\\033[0;32m"\n\
YELLOW="\\033[0;33m"\n\
NC="\\033[0m"\n\
\n\
echo -e "${BLUE}=====================================${NC}"\n\
echo -e "${GREEN}  Pentest Lab - Module BASE${NC}"\n\
echo -e "${BLUE}=====================================${NC}"\n\
echo ""\n\
echo -e "${YELLOW}Outils disponibles :${NC}"\n\
echo " - Nmap              : $(nmap --version | head -n1)"\n\
echo " - Netcat (nc)       : $(nc -h 2>&1 | head -n1)"\n\
echo " - Socat             : $(socat -V 2>&1 | head -n1)"\n\
echo " - Sqlmap            : $(sqlmap --version 2>&1 | head -n1)"\n\
echo " - Nikto             : $(nikto -Version 2>&1 | head -n1)"\n\
echo " - Metasploit        : $(msfconsole --version 2>&1 | head -n1)"\n\
echo " - Pwntools (Python) : \$(python3 -c '\''import pkg_resources; print(pkg_resources.get_distribution(\"pwntools\").version)'\'' )"\n\
echo ""\n\
echo -e "${YELLOW}Dossier de travail :${NC} /workspace"\n\
echo -e "${YELLOW}Utilisateur        :${NC} kali"\n\
echo -e "${BLUE}=====================================${NC}"\n\
\n\
# ===== Logging automatique =====\n\
log_and_run() {\n\
    TOOL=$1; shift\n\
    TARGET=$(echo "$@" | grep -oE "([a-zA-Z0-9.-]+\\.[a-z]{2,}|[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)" | head -n1)\n\
    DATE=$(date +"%Y-%m-%d_%H-%M-%S")\n\
    OUTDIR="/reports/${TARGET}/${TOOL}"\n\
    OUTFILE="${OUTDIR}/${TOOL}_${DATE}.txt"\n\
    mkdir -p "$OUTDIR"\n\
    echo "[*] $TOOL lancé sur $TARGET..."\n\
    command $TOOL "$@" | tee "$OUTFILE"\n\
    echo "[+] Résultat sauvegardé : $OUTFILE"\n\
}\n\
\n\
# Aliases avec log auto\n\
alias nmap="log_and_run nmap"\n\
alias nikto="log_and_run nikto"\n\
alias gobuster="log_and_run gobuster"\n\
alias wfuzz="log_and_run wfuzz"\n\
alias sqlmap="log_and_run sqlmap"\n\
alias hydra="log_and_run hydra"\n\
alias john="log_and_run john"\n\
alias hashcat="log_and_run hashcat"\n\
alias msfconsole="log_and_run msfconsole"\n\
alias searchsploit="log_and_run searchsploit"\n\
' >> /home/kali/.bashrc

# ===========================================
# Configuration finale
# ===========================================
USER kali
WORKDIR /workspace

RUN echo "if [ -f ~/.bashrc ]; then . ~/.bashrc; fi" >> /home/kali/.bash_profile

CMD ["bash", "-lc", "source ~/.bashrc && exec bash"]
